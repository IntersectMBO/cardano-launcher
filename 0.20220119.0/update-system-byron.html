<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>update-system-byron</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="update-system-notes">Update system notes</h1>
<p>These are notes on how the Cardano wallet launcher and update system currently work.</p>
<h2 id="old-design">Old Design</h2>
<h3 id="diagram">Diagram</h3>
<p>This is the <code>frontendOnlyScenario</code> from <code>cardano-sl/tools/src/launcher/Main.hs</code>. Do not worry about <code>serverScenario</code> - replace it completely.</p>
<p>The Daedalus install is always configured to run the launcher in <code>frontendOnlyMode</code>. The other code (<code>clientScenario</code>) is dead code. The diagram describes <code>frontendOnlyMode</code>, which goes through the <code>node-ipc</code> system.</p>
<figure>
<img src="update-system-old.png" alt="sequence-chart" /><figcaption aria-hidden="true">sequence-chart</figcaption>
</figure>
<h4 id="running-the-update-system">Running the update system</h4>
<p>The very first thing that <code>cardano-launcher</code> does, before starting the frontend, is check for a previously downloaded update.</p>
<p>If there is a file at <code>updaterPath</code>, it runs the updater, which is a bit wrong.</p>
<p>There are two code paths, depending on whether launcher is running on Windows.</p>
<h5 id="macos-and-linux">macOS and Linux</h5>
<p>To run the updater on non-Windows systems, it will spawn <code>${updaterPath} ${updaterArgs} ${updateArchive}</code>.</p>
<p>After the update subprocess exits successfully, it hashes the <code>updateArchive</code> file, checks that the wallet database has this hash, then deletes the <code>updateArchive</code> file.</p>
<h5 id="windows">Windows</h5>
<p>To run the updater on Windows systems, it will create a <code>.bat</code> file then execute it. The temporary <code>.bat</code> file runs the following steps:</p>
<ol type="1">
<li>Kill the <code>cardano-launcher</code> process with <code>TaskKill /PID</code></li>
<li>Run the downloaded installer for the new version.</li>
<li>Delete the installer file.</li>
<li>Run <code>cardano-launcher</code> with the same command line arguments that the previous launcher was run with.</li>
<li>Delete the <code>.bat</code> file.</li>
</ol>
<h4 id="starting-daedalus">Starting Daedalus</h4>
<p>Daedalus is started by running Electron, with the main Javascript file being in a subdirectory (the exact filename is configured by the <code>main</code> key of <code>package.json</code>)</p>
<p>The Daedalus Window title bar is configured using the <code>productName</code> key of <code>package.json</code>.</p>
<p>Daedalus uses a number of variables at runtime.</p>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th style="text-align: left;">Description</th>
<th>Set by</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>NETWORK</code></td>
<td style="text-align: left;">Used to show the user what network Daedalus is</td>
<td>Build</td>
</tr>
<tr class="even">
<td></td>
<td style="text-align: left;">connecting to. One of <code>mainnet</code>, <code>staging</code>, <code>testnet</code>.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>REPORT_URL</code></td>
<td style="text-align: left;">The base URL for posting Daedalus automatic bug</td>
<td>Build</td>
</tr>
<tr class="even">
<td></td>
<td style="text-align: left;">reports.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>API_VERSION</code></td>
<td style="text-align: left;">Used to show the Cardano version in the About box.</td>
<td>Build</td>
</tr>
<tr class="even">
<td><code>LAUNCHER_CONFIG</code></td>
<td style="text-align: left;">Path to a launcher config YAML file.</td>
<td>Launcher</td>
</tr>
</tbody>
</table>
<p>The variables listed as being set by “Build” are in fact hard-coded using string substitution at installer build-time, but this need not be the case.</p>
<h4 id="starting-cardano-node">Starting <code>cardano-node</code></h4>
<p>Daedalus spawns the <code>cardano-node</code> process using <a href="https://nodejs.org/api/child_process.html">child_process</a>. The command-line parameters are built from the file specified by <code>LAUNCHER_CONFIG</code>.</p>
<p>After starting the <code>cardano-node</code> process, it then uses the nodejs API to pass “messages” to the subprocess (see <code>cardano-sl/node-ipc/src/Cardano/NodeIPC.hs</code>).</p>
<h4 id="applying-updates">Applying updates</h4>
<p>To apply an update, <code>cardano-launcher</code> just loops back to the start, where the update system will immediately run.</p>
<h4 id="update-server">Update server</h4>
<p>The update server is a S3 bucket managed by the IOHK Service Reliability team, accessible by HTTPS. Before proposing an update on the blockchain, the installer files are uploaded to the updates bucket, named with their Blake2b hash.</p>
<p>As an example: <a href="https://updates-cardano-testnet.s3.amazonaws.com/index.html">the testnet update server</a></p>
</body>
</html>
